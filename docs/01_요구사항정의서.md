# 요구사항 정의서

----

## 1. 시스템 개요

- 회원 대상 쿠폰 발급, 조회, 사용, 만료, 추첨 기능 제공
- 이벤트성 대량 사전 발급 중심으로 안전성 확보
- 이벤트 → 발급회차 → 발급코드 → 재휴사매핑 → 사용 → 추첨 전체 흐름관리
- 장애복구 및 확장성을 고려한 아키텍처 설계 목표


---

## 2. 주요 쿠폰 발급 방식

### 1) 자체발번 → 제휴사 제공 방식

- 시스템에서 사전생성된 쿠폰코드를 제휴사에 제공
- 제휴사가 오프라인, 온라인 채널 통해 배포
- 이벤트 종료 후 유입 → 혜택 제공

## 2) 제휴사 발번 → 자체 매핑 방식

- 제휴사 자체 쿠폰코드 발급 → 파일업로드
- 시스템에서 사전생성된 내부 쿠폰코드와 매핑
- 이벤트 종료 후 매핑된 쿠폰을 유입하여 발급

---

## 3. 쿠폰코드 정책

| **항목** | **내용** |
|:-:|:-:|
| 쿠폰코드 길이 | 8자리 |
| 문자 조합 | 대문자 + 숫자 (I, O, 0, 1 제외 가능) |
| 고유성 확보 | DB Unique Index |
| 생성방식 | 사전 대량생성 (Batch Insert, Bloom Filter 적용) |

---

## 4. 주요 도메인

| **도메인** | **설명** |
|:-:|:-:|
| **Event** | 이벤트 단위 |
| **CouponPolicy** | 쿠폰 할인정책 |
| **CouponInventory** | 이벤트 & 정책 단위 총발급 Pool |
| **CouponBatch** | 발급회차 (배치코드로 구분) |
| **CouponCode** | 실제 사전생성된 쿠폰코드 |
| **PartnerCoupon** | 제휴사 업로드 쿠폰코드 |
| **CouponMapping** | 제휴사 ↔ 내부쿠폰 매핑정보 |
| **CouponIssue** | 발급 이력 |
| **CouponUsage** | 사용 이력 |
| **EventParticipant** | 이벤트 참여자 (추첨 대상) |
| **DrawWinner** | 추첨 당첨 이력 |


---

## 5. 상세 기능 요구사항

### 1) 이벤트 관리

- 이벤트명, 기간, 이벤트정보 관리
- 반복가능한 이벤트 설계 가능

### 2) 쿠폰 정책 관리 (일반 쿠폰을 위한 추가)
- 정액/정율 할인, 최소주문금액 설정
- 정책 변경 불가

### 3) 쿠폰코드 사전생성
- 이벤트 → 발급Pool → 발급회차 → 쿠폰코드 구조로 생성
- 발급회차는 batch_code로 관리
- 중복제어 (Bloom Filter + Unique Index)
- 1,000만건 이상 대량발급 안정성 확보

### 4) 제휴사 쿠폰 매핑
- 제휴사 쿠폰코드 파일 업로드
- 내부쿠폰과 매핑
- 실패이력 기록 및 재처리 API 제공

### 5) 쿠폰 발급처리
- 자체발급: AVAILABLE → ISSUED 전환
- 제휴발급: 매핑된 쿠폰 발급 처리

### 6) 쿠폰 사용처리
- 사용시 ISSUED → USED 전환
- 트랜잭션 기반 장애시 롤백 보장

### 7) 쿠폰 만료처리
- 유효기간 종료 → EXPIRED 전환
- 스케줄링 배치 처리 가능

### 8) 이벤트 참여 관리
- 참여자 기록 (EventParticipant)
- 참여일시 기록
- 참여제한/취소 관리 가능
- 내부직원 제외

### 9) 추첨 기능
- 이벤트 종료 후 추첨
- 참여자 집계 → 랜덤 추첨 → 당첨자 기록 (DrawWinner)
- 이벤트 추첨, 감사이력 확보 가능

----

## 6. 비기능 요구사항

| **항목** | **내용** |
|:-:|:-:|
| 발급 성능 | 초당 50건 이상 발급 |
| 대량생성 성능 | 1,000만건 이상 사전생성 지원 |
| 확장성 | MSA 분리 (발급/매핑/사용/추첨 분리 가능성 확보) |
| 장애복구 | DLQ, Retry, 재처리 설계 포함 |
| 운영성 | 이력조회, 모니터링, 감사로그 확보 |
| 배포 | 무중단 배포 및 CI/CD 적용 가능성 확보 |

---

## 7. 장애대응 요구사항

| **장애유형** | **대응방안** |
|:-:|:-:|
| 중복발급 | Bloom Filter + DB Unique Index |
| 발급경합 | Redis Distributed Lock |
| 업로드실패 | 검증 및 재처리 API 제공 |
| 사용중장애 | 트랜잭션 롤백 적용 |
| 대량발급장애 | Bulk Insert 분할 및 재시도 설계 |
| 추첨장애 | 추첨이력 유지, 재실행 가능 |

---

## 8. 확장요구사항

- 이벤트 유형 확장 가능성 확보
- 쿠폰 정책 템플릿 관리 가능성 확보
- 관리자 운영툴 제공 고려
- 정산시스템 연계 고려
